---
title: "An Introduction to MF.beta4 via Examples"
author: "Anne Chao, Chun-Yu Liu, K. H. Hu"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    vignette: >
      %\VignetteIndexEntry{A Quick Introduction to MF.beta4 via Examples}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", 
                      fig.retina = 2,
                      fig.align = 'center',
                      fig.width = 7, fig.height = 5,
                      warning = FALSE, message = FALSE)
options("width"=200)
library(MF.beta4)
library(tidyverse)
library(grid)
library(dplyr)
#load("EF_multiple.rda")
```

<font color=#FF6600>
</font>

`MF.beta4` is an R package for measuring ecosystem multifunctionality and assessing BEF relationships. The measures are illustrated by using ecosystem function and biodiversity data collected in
a total of 209 plots in six European countries (the FunDivEUROPE dataset). All data are available
from the Dryad repository; see Ratcliffe et al. (2017) and Scherer-Lorenzen et al. (2023) for details. The software was originally developed for the Beta4 project (Müller et al. 2022) on the effect
of enhancing the beta diversity between forest patches on ecosystem multifunctionality and forest
resilience across spatial scales.

Based on a framework of Hill-Chao numbers of orders q = 0, 1 and 2, `MF.beta4` features the following multifunctionality measures for a single and multiple ecosystems; see Chao et al. (2023) for
pertinent methodology and decomposition theory.



(1) <u>Multifunctionality measures in a single ecosystem:</u>  

`MF.beta4` computes a class of weighted
multifunctionality measures for given function weights. Multifunctionality measures that correct
for strong correlations between ecosystem functions to avoid redundancy are also provided.


(2) <u>Multifunctionality measures in multiple ecosystems:</u>

for given function weights, `MF.beta4` computes the gamma multifunctionality of pooled ecosystems, the within-ecosystem component (alpha
multifunctionality) and among-ecosystem component (beta multifunctionality).

\

Based on biodiversity and function data from ecosystems, this package also provides graphics for
assessing the biodiversity-ecosystem functioning (BEF) relationships across scales.

## How to cite

If you publish your work based on results from `MF.beta4` package, you should make references to the following methodology paper and Online software:

<li> Chao, A., Chiu, C. H., Hu, K. H., van der Plas, F., Cadotte, M. W., Mitesser, O., et al. (2023). Hill-Chao numbers in multifunctionality allows decomposing gamma multifunctionality into alpha and beta components. Under revision, <i>Ecology Letters</i>.</li>
\
<li> Müller, J., Mitesser, O. Cadotte, M. W., van der Plas, F., Mori, A, Ammer, C. . . . , Eisenhauer N.
(2023). Enhancing the structural diversity between forest patches – a concept and real-world experiment to study biodiversity and multifunctionality across spatial scales. Global Change Biology,
29, 1437–1450.</li>
\
<li> Ratcliffe, S. Wirth, C., Jucker, T. van der Plas, F., Scherer-Lorenzen, M. Verheyen, K. et al. (2017).
Biodiversity and ecosystem functioning relations in European forests depend on environmental context. Ecology Letters, 20, 1414–1426.</li>
\
<li> Scherer-Lorenzen, M. et al. (2023). The functional significance of tree species diversity in European forests - the FunDivEUROPE dataset [Dataset]. Dryad. <a href=" https://doi.org/10.5061/dryad.9ghx3ffpz">  https://doi.org/10.5061/dryad.9ghx3ffpz</a></li>

## SOFTWARE NEEDED TO RUN MF.beta4 IN R
- Required: [R](https://cran.r-project.org/)
- Suggested: [RStudio IDE](https://www.rstudio.com/products/RStudio/#Desktop)

## HOW TO RUN MF.beta4:

The `MF.beta4` package can be downloaded from Anne Chao's [MF.beta4_github](https://github.com/AnneChao/MF.beta4) using the following commands. For a first-time installation, an additional visualization extension package (`ggplot2`) must be installed and loaded.

```{r eval=FALSE}
## install MF.beta4 package from CRAN
# install.packages("MF.beta4")  # coming soon

## install the latest version from github
install.packages('devtools')
library(devtools)
install_github("AnneChao/MF.beta4")

## import packages
library(MF.beta4)
```


This package includes four main functions: 

- **function_normalization** : transforms ecosystem functions data to values between 0 and 1.
- **MF1_single** : computes a class of weighted multifuctionality measures in a single ecosystem for
given individual function weights separately for two cases: (i) correlations between functions are
not corrected for, and (ii) correlations between functions are corrected.
- **MF2_multiple** :  alpha, beta and gamma multifuctionality measures in multiple ecosystems for given function weights separately for two cases (i) correlations between functions are not corrected for, and (ii) correlations between functions are corrected.
- **MFggplot** : provides the graphical BEF relationships based on the output from the function `MF1_single` or `MF2_multiple`.

## Normalize raw ecosystem function values to [0,1]: function_normalization()

We first describe the normalization function `function_normalization()` with default arguments. The arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text.

```{r eval=FALSE}
function_normalization(data, fun_cols = 1:ncol(data), negative = NULL, by_group = NULL) 
```

<code>function_normalization</code> transforms raw function values to values between 0 and 1. For positive
functionality, ecosystems with the highest value in the raw function data are transformed to the
maximal value of 1, and those with the lowest raw value are transformed to the minimum value
of 0. Because the value “0” always implies absent functions, if the lowest raw value is not 0, the
transformed 0 from this non-zero raw value will be replaced by a very small number, e.g., $10^{-5}$.
In a similar manner, for negative functionality, if the highest raw value is not 0, the transformed 0
will also be replaced by a very small number, e.g., $10^{-5}$. These replacements will not affect any
numerical computations but will help indicate that the transformed values represent functions that
should be regarded as “present” ones. Thus, present or absent functions can be clearly distinguished
in the transformed data, and the information on presence/absence of functions is required in the
decomposition of multifunctionality among ecosystems.


<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>data</code></td>
<td align="left">data can be input as a <code>data.frame</code> with ecosystems/plots as rows and relevant
ecosystem/plot information and ecosystem functions as columns. All missing values should be imputed in the input data. </br> 
If <code>by_group</code> is not <code>NULL</code>, data must contain a <code>by_group</code> column.</td>

</tr>
<tr class="even">
<td align="center"><code>fun_cols</code></td>
<td align="left">the columns represent ecosystem functions.</td>

</tr>
<tr class="odd">
<td align="center"><code>negative</code></td>
<td align="left">names of the negative functionality.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left">name of the column for normalization, i.e., function normalization will be performed within each group classified by the categories of that column variabl</br>
For example, if <code>by_group = “country”</code>, then all functions will be normalized to the range of [0, 1] within a country. Default is <code>NULL</code>.</td>
</tr>

</tbody>
</table>

This function returns a <code>data.frame</code> with all values in functions (specified in <code>fun_cols</code>) being replaced by the transformed values between 0 and 1.


## multifunctionality measures for a single ecosystem: MF1_single()

One of the main function to measure MF is `MF1_single()`, the arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text. 

```{r eval=FALSE}
MF1_single(func_data, species_data = NULL, weight = 1, q = c(0, 1, 2))
```

`MF1_single` computes multifunctionality measures of orders q = 0, 1 and 2 for given function
weights in a single ecosystem separately for two cases: \
(i)  correlations between functions are not corrected for.\
(ii)  correlations between functions are corrected.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>func_data</code></td>
<td align="left">ecosystem function data can be input as a <code>data.frame</code> (ecosystems by functions).</br>
All function values must be normalized between 0 and 1.</br>
The row names of <code>func_data</code> should be set the same as the names of 'plotID' specified in <code>species_data</code> if the latter is not <code>NULL</code>. </td>

</tr>
<tr class="even">
<td align="center"><code>species_data</code></td>
<td align="left">species abundance data can be input as a <code>data.frame</code> and must include three columns: ’plotID’, ’species’ and ’abundance’ (or any proxy such as basal area). Default is <code>NULL</code>.</td>

</tr>
<tr class="even">
<td align="center"><code>weight</code></td>
<td align="left">a constant number (if all weights are equal) or a numerical vector specifying weights for ecosystem functions. In the latter case, the length of <code>weight</code> must be equal to the number of functions.</br>
Default is <code>weight = 1</code>, which means equal weight and weight = 1 for all ecosystem functions.</td>

</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">a numerical vector specifying the multifunctionality and diversity orders. Default is q = 0, 1 and 2.</td>
</tr>

</tbody>
</table>

This function returns a <code>data.frame</code> with columns ’plotID’, ’Type’ (uncorrected or corrected for correlations), ’Order.q’
and ’qMF’. When <code>species_data</code> is not <code>NULL</code>, the <code>data.frame</code> will include an additional column
’Species.diversity’.


## multifunctionality measures for multiple ecosystems: MF2_multiple()

The other main function to measure MF is `MF2_multiple()`, the arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text.  

```{r eval=FALSE}
MF2_multiple(func_data, species_data = NULL, weight = 1, q = c(0, 1, 2), by_group = NULL) 
```

`MF2_multiple` computes alpha, beta and gamma multifuctionality measures of orders q = 0, 1 and 2
for given function weights in multiple ecosystems separately for two cases: \
(i) correlations between functions are not corrected for.\
(ii) correlations between functions are corrected.\

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>func_data</code></td>
<td align="left"> ecosystem function data can be input as a <code>data.frame</code> (ecosystems by functions for multiple ecosystems). All function values must be normalized between 0 and 1.</br>
For <code>by_group = NULL</code>, the <code>func_data</code> must contain only the ecosystem function columns. (e.g., those columns specified in the argument <code>fun_cols</code> if user use
<code>function_normalization</code> to do normalization). If <code>by_group</code> is not <code>NULL</code>,in addition to ecosystem function columns, the group name column must be included.</br>
The row names of <code>func_data</code> should be set the same as the names of 'plotID' specified in <code>species_data</code> if the latter is not <code>NULL</code>.</td>


</tr>
<tr class="even">
<td align="center"><code>species_data</code></td>
<td align="left">species abundance data can be input as a <code>data.frame</code> and must include three
columns: ’plotID’, ’species’ and ’abundance’. Default is <code>NULL</code>.</td>

</tr>
<tr class="even">
<td align="center"><code>weight</code></td>
<td align="left">a constant number (if all weights are equal) or a numerical vector specifying weights for ecosystem functions. In the latter case, the length of <code>weight</code> must be equal to the number of functions.</br>
Default is <code>weight = 1</code>, which means equal weight and weight = 1 for all ecosystem functions.</td>

</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">a numerical vector specifying the multifunctionality and diversity orders. Default is q = 0, 1 and 2.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left">name of the column for decomposition, i.e., multifunctionality decomposition will be performed within each group classified by the categories of that column variable. </br>
The <code>by_group</code> setting must be the same as that set in <code>function_normalization</code>.
Default is <code>NULL</code>.
</td>
</tr>
</tbody>
</table>



This function returns a <code>data.frame</code> with columns ’plotID’ (combinations of plots by paired), ’Order.q’ , ’Type’ (uncorrected or corrected for correlations) , ’Scale’ (gamma, alpha or beta) and ’qMF’. For <code>species_data</code> is not <code>NULL</code>, the <code>data.frame</code> will show an additional column contain ’Species.diversity’. When <code>by_group</code> is not <code>NULL</code>, the <code>data.frame</code> will include an additional column whose name is the same as the setting of <code>by_group</code>.


## Data input format

#### Ecosystem functions data

The input data for L ecosystem functions should be arranged as a <code>data.frame</code> with ecosystems/plots in rows, and ecosystem function values in columns; here each plot is designated as an ecosystem. The first row starting from column B lists the relevant plot information and the names for the L functions; see an example below. Beginning with the second row, the first entry for column A in each row denotes plot id or plot label, followed by the relevant plot information and  L function values. 

A forest tree species and ecosystem function data is included in `MF.beta4` package for illustration. This dataset includes raw values of 26 ecosystem functions collected from 209 plots (each with 30 m × 30 m) in six European countries, representing six major European
forest types: boreal forest (Finland, 28 plots); hemi-boreal (Poland, 43 plots); temperate deciduous (Germany, 38 plots); mountainous deciduous (Romania, 28 plots); thermophilous deciduous (Italy, 36 plots); and Mediterranean mixed (Spain, 36 plots). See Table 1 of Ratcliffe et al. (2017) for a description of the 26 functions. Each plot is designated as an ecosystem in assessing BEF relationships. See Ratcliffe et al. (2017) and Scherer-Lorenzen et al. (2023) for the original dataset. For each missing value of functions in the original dataset, the mean of the given function within the country was imputed. And for analysis, add a column of countries for each plot. Thus, the dataset provided with the package is slightly different from the original dataset.


Run the following code to view raw forest data: (Here we only show the first ten rows and the first two ecosystem functions)

```{r  fig.width=10, eval=FALSE}
data("forest_function_data_raw")
head(cbind(forest_function_data_raw[1:3], round(forest_function_data_raw[6:7], 3)), 10)
```

```{r  fig.width=10, echo=FALSE}
data("forest_function_data_raw")
head(cbind(forest_function_data_raw[1:3], round(forest_function_data_raw[6:7], 3)), 10)
```

Since the data is not normalized, we then use `function_normalization` to do normalization. Note that, in this data, the ecosystem functions are column 6 to column 31. And there are two ecosystem functions should be normalized negatively: `"soil_cn_ff_10"` and `"wue"`. Furthermore, the performance of the ecosystem functions are quite different between six countries, thus, we do normalization and analysis among each countries.

Run the following code to view normalized forest function data: (Here we only show the first ten rows and the first two ecosystem functions)

```{r fig.width=10, eval=FALSE}
data("forest_function_data_raw")
normalized_forest_function_data <- function_normalization(data = forest_function_data_raw,
                    fun_cols = 6:31, negative = c("soil_cn_ff_10","wue"), by_group = "country")
head(cbind(normalized_forest_function_data[1:3], round(normalized_forest_function_data[6:7], 3)), 10)
```

```{r fig.width=10, echo=FALSE}
data("forest_function_data_raw")
normalized_forest_function_data <- function_normalization(data = forest_function_data_raw,
                    fun_cols = 6:31, negative = c("soil_cn_ff_10","wue"), by_group = "country")
head(cbind(normalized_forest_function_data[1:3], round(normalized_forest_function_data[6:7], 3)), 10)
```

This normalized data is same as the data `forest_function_data_normalized` in `MF.beta4` package .


#### Biodiversity data

The input data include three columns: the "plotID" column includes the name of ecosystems/plots, the "species" column includes species names, and the "abundance" column includes the corresponding species abundance.

A biodiversity data for six European forests is included in `MF.beta4` package for illustration. In addition to row and column names, the original dataset consists of three columns: the “plotID” column indicates the names of plots, the “species” column includes species names, and the column “abundance” (basal area as a proxy of species abundance); see Scherer-Lorenzen et al. (2023) for the original dataset. Because missing values of “basal area” in the original dataset were imputed by the mean of the same species within the country, and basal areas were combined for two almost indistinguishable species (Betula pendula and Betula pubescens), the dataset provided with the package is slightly different from the original dataset.

Run the following code to view biodiversity data: (Here, we only show the first ten rows.)

```{r eval=FALSE}
data("forest_biodiversity_data")
head(forest_biodiversity_data,10)
```

```{r echo=FALSE}
data("forest_biodiversity_data")
head(forest_biodiversity_data,10)
```

### Computing Multifunctionality in Single Ecosystem Via Example

#### If the `species_data` is not provided

For demonstration, given a normalized data, we run the `MF1_single()` function without setting `species_data` and with setting `species_data` to compute uncorrected for correlations and corrected for correlations multifunctionality. (Here we only show the first ten outputs)


```{r echo=TRUE}
data("forest_function_data_normalized")
single_without_species <- MF1_single(func_data = forest_function_data_normalized[,6:31],weight = 1)
```

```{r, echo=FALSE}
single_without_species %>% mutate(qMF = round(qMF,3)) %>% as.data.frame() %>% head(10)
```


The output contains ID of plot (`plotID`) which is according to the row names of the input data, `Type` (uncorrected for correlations or corrected for correlations), the diversity order (`Order.q`) and multifunctionality (`qMF`).


#### If there is `species_data` given to function `MF1_single`


```{r echo=TRUE}
data("forest_function_data_normalized")
data("forest_biodiversity_data")
single_with_species <- MF1_single(func_data = forest_function_data_normalized[,6:31],weight = 1 ,
           species_data = forest_biodiversity_data)
```

```{r echo=FALSE}
single_with_species %>% mutate(qMF = round(qMF,3),
                          Species.diversity = round(Species.diversity,3)) %>% head(10)

```


The output has only one more column `Species.diversity` than the previous one.


### Computing Decomposition of Multifunctionality In Multiple Ecosystems Via Example

For demonstration, we run the `MF2_multiple()` function with forest data to compute uncorrected for correlations and corrected for correlations multifunctionality relationships across spatial scales. (Here we only show the first ten outputs)

```{r eval=FALSE}
data("forest_function_data_normalized")
data("forest_biodiversity_data")
multiple_ecosystem = MF2_multiple(func_data = forest_function_data_normalized[,6:32],
                      species_data = forest_biodiversity_data,
                      weight = 1,
                      by_group = "country")
```

```{r include=FALSE}
data("forest_function_data_normalized")
data("forest_biodiversity_data")
Demo_multiple = MF2_multiple(func_data =  forest_function_data_normalized[,6:32],
                      species_data = forest_biodiversity_data,
                      weight = 1,
                      by_group = "country")

multiple_ecosystem <- Demo_multiple %>%
  mutate(Type=factor(Type,levels = unique(Type)),
         Scale=factor(Scale,levels = unique(Scale))) %>%
  group_by(plotID,country,Type,Scale) %>%
  summarise(Order.q=Order.q,
            qMF=round(qMF,3),
            Species.diversity=round(Species.diversity,3))
```


```{r echo=FALSE}
head(as.data.frame(multiple_ecosystem), 10)
multiple_ecosystem <- Demo_multiple
```


Each row of the output represents the decomposition of species diversity and multifunctionality across two plots. The output contains ID (`plotID`) which is according to the row names of the input data, `Country` of two plots, `Type` (uncorrected for correlations or corrected for correlations), `Scale` (gamma, alpha or beta), the diversity order (`Order.q`), multifunctionality (`qMF`) and decomposition of species diversity(`Species.diversity`).

For `species_data` is not provided, the column of decomposition of species diversity are not included in the output.

## ggplot2 extension for a `MF1_single` or `MF2_multiple` object: Function MFggplot()

The function `MFggplot()`, which extends `ggplot2` to the `"MF"` output object with default arguments are briefly described below, and will be explained in more details by illustrative examples in later text : 

```{r eval=FALSE}
MFggplot(output, by_group = NULL, model = "LMM.both", caption = "slope")
```

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>output</code></td>
<td align="left"> the output obtained from <code>MF1_single</code> or <code>MF2_multiple</code>.</br>
For output obtained from <code>MF1_single</code>, if BEF relationships are desired within
each category specified <code>by_group</code>, the <code>by_group</code> column must be included in the input.</td>


</tr>
<tr class="even">
<td align="center"><code>model</code></td>
<td align="left">specifying the fitting model, <code>model = "lm"</code> for linear model; <code>model = "LMM.intercept"</code>, <code>"LMM.slope"</code> and <code>"LMM.both"</code> for linear mixed models with random effects for intercepts, slopes, and both, respectively. Default is <code>model = "LMM.both"</code>.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left">name of the column for fitting model i.e., model will be fitted within each group classified by the categories of that column. Default is <code>NULL</code>.</br>
It is required if a linear mixed model is selected in the <code>model</code>.</br>
If the output is obtained from <code>MF2_multiple</code>, the <code>by_group</code> setting must be the same as that set in <code>MF2_multiple</code>.
</td>

</tr>
<tr class="odd">
<td align="center"><code>caption</code></td>
<td align="left">caption that will be shown in the BEF plots; <code>caption = "slope"</code> to show the
estimated slopes in each plot, or <code>caption = "R.squared"</code> to show the ordinary
R-squared for linear models or estimated marginal and conditional R-squared for linear mixed models in each plot. Default is <code>caption = "slope"</code>.</td>

</tr>

</tbody>
</table>


For an <code>MF1_single</code> object of given individual function weights, this function plots the BEF relationship between multifunctionality of order q (= 0, 1 and 2) and species diversity of the same order
q for two cases:</br> 
(i) correlations between functions are not corrected for. </br>
(ii) correlations between functions are corrected. </br>
The fitted lines for the chosen fitting model are also shown in the figure.

For an <code>MF2_multiple</code> object of given individual function weights, this function plots the BEF relationship between alpha/beta/gamma multifunctionality of order q (= 0, 1 and 2) and the corresponding alpha/beta/gamma species diversity of the same order q for two cases: </br> 
(i) correlations between functions are not corrected for. </br> 
(ii) correlations between functions are corrected. </br> 
The fitted lines for the chosen fitting model are also shown in the figure.



We first display multifunctionality in single ecosystem without `by_group` and with `by_group`.
```{r, fig.align='center', fig.height=6.5, fig.width=6.5}
MFggplot(single_with_species, model = "lm")
```


```{r, fig.align='center', fig.height=6.5, fig.width=6.5}
single_with_species <- data.frame("plotID"=rownames(forest_function_data_raw),
                      "country"=forest_function_data_raw$country) %>%
  left_join(single_with_species,.,by="plotID")
MFggplot(single_with_species, model = "LMM.both", by_group = "country")
```

Without `by_group`, we can only fit linear model, and for the example with `by_group`, we fit linear mixed model with random effect 'intercept' and 'slope' of fitted line.

And then, we display decomposition of multifunctionality in multiple ecosystems with linear model fitted line and linear mixed model with random effect 'intercept' and 'slope' of fitted line.

```{r}
figure_lm <- MFggplot(multiple_ecosystem, by_group = "country", model = "lm")
figure_LMM <- MFggplot(multiple_ecosystem, by_group = "country",  model = "LMM.both",caption = "R.squared")
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_lm$Corrected_for_correlations$ALL
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_lm$Uncorrected_for_correlations$ALL
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_LMM$Corrected_for_correlations$ALL
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_LMM$Uncorrected_for_correlations$ALL
```
