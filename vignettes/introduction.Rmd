---
title: "A Quick Introduction to MF.beta4 via Examples"
author: "Anne Chao, Chun-Yu Liu"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    vignette: >
      %\VignetteIndexEntry{A Quick Introduction to MF.beta4 via Examples}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", 
                      fig.retina = 2,
                      fig.align = 'center',
                      fig.width = 7, fig.height = 5,
                      warning = FALSE, message = FALSE)
options("width"=200)
library(MF.beta4)
library(tidyverse)
library(grid)
library(dplyr)
load("Demo_EF.rda")

```

<font color=#FF6600>
</font>

`MF.beta4c is a R package for measuring ecosystem multifunctionality and assessing BEF relationships. It was originally developed for the Beta4 project (MÃ¼ller et al. 2022) on the effect of enhancing the beta diversity between forest patches on ecosystem multifunctionality and forest resilience across spatial scales.

Based on a framework of Hill-Chao numbers of orders q = 0, 1 and 2, `MF.beta4` features the following multifunctionality measures for a single and multiple ecosystems; see Chao et al. (2023) for pertinent methodology and decomposition theory.  

(1) <u>Multifunctionality measures in a single ecosystem</u> 

`MF.beta4` computes a class of weighted multifunctionality measures for given function weights. Multifunctionality measures that correct for strong correlations between ecosystem functions to avoid redundancy are also provided.  

(2) <u>Multifunctionality measures in multiple ecosystems</u>

`MF.beta4` computes gamma multifunctionality of pooled ecosystems, within-ecosystem component (alpha multifunctionality) and among-ecosystem component (beta multifunctionality).

Based on biodiversity and function data from ecosystems, this package also facilitates graphics for assessing the biodiversity-ecosystem functioning (BEF) relationships across scales by `ggMF`.

## How to cite

If you publish your work based on results from `MF.beta4` package, you should make references to the following methodology paper and Online software:

<li> Chao, A., Chiu, C. H., Hu, K. H., van der Plas, F., Cadotte, M. W., Mitesser, O., et al. (2023). Hill-Chao numbers in multifunctionality allows decomposing gamma multifunctionality into alpha and beta components. Under revision, <i>Ecology Letters</i>.</li>
<li> Chao, A. and Hu, K.-H. (2023) MF.beta4: Software for measuring ecosystem multifunctionality and assessing BEF relationships. . Code and User's guide available from <a href="http://chao.stat.nthu.edu.tw/wordpress/software_download/MF-beta4/">http://chao.stat.nthu.edu.tw/wordpress/software_download/MF-beta4/</a></li>

## SOFTWARE NEEDED TO RUN MF.beta4 IN R
- Required: [R](https://cran.r-project.org/)
- Suggested: [RStudio IDE](https://www.rstudio.com/products/RStudio/#Desktop)

## HOW TO RUN MF.beta4:

The `MF.beta4` package can be downloaded from Anne Chao's [MF.beta4_github](https://github.com/AnneChao/MF.beta4) using the following commands. For a first-time installation, an additional visualization extension package (`ggplot2`) must be installed and loaded.

```{r eval=FALSE}
## install iNEXT.3D package from CRAN
# install.packages("iNEXT.3D")  # coming soon

## install the latest version from github
install.packages('devtools')
library(devtools)
install_github("Jyunyao/MF.beta4")

## import packages
library(MF.beta4)
```


Here are four main functions we provide in this package : 

- **func_normalized** :  Normalizing ecosystem functions data and turn all values between 0 and 1.
- **MF_single** : Computing quantification of multifuctionality measures in a single ecosystem when all functions are assumed to be independent, and when the correlation between any two functions is adjusted for. In the latter case, our MF value is obtained based on an integrated measure by considering all possible threshold levels.
- **MF_multiple** : Computing decomposition of multifuctionality measures in multiple ecosystems when all functions are assumed to be independent, and when the correlation between any two functions is adjusted for. In the latter case, our MF value is obtained based on an integrated measure by considering all possible threshold levels.
- **ggMF** : Visualizing the output from the function `MF_single` or `MF_multiple`.


## Normalized the raw data: func_normalized()

We first describe the normalized function `func_normalized()` with default arguments, and the arguments of this function are briefly described below.

```{r eval=FALSE}
func_normalized <- function(data, fun_cols = 1:ncol(data), negative = NULL, by_group = NULL) 
```

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>data</code></td>
<td align="left">
Data can be input as a <code>matrix</code>/<code>data.frame</code> (assemblages by functions).</br>
Data should be without NA, if does, the missing values need to impute first and then use the function.</td>

</tr>
<tr class="even">
<td align="center"><code>fun_cols</code></td>
<td align="left">The order number of the columns which be used as the ecosystem function.</td>

</tr>
<tr class="odd">
<td align="center"><code>negative</code></td>
<td align="left">Name of columns which need to be normalized negatively.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left"> Name of the column to be normalized by group. Default is <code>NULL</code>.</td>
</tr>

</tbody>
</table>

This function returns a data.frame with normalized functions.


## Multi-functionality: MF_single()

One of the main function to measure MF is `MF_single()`, and the following is default arguments of the function: 

```{r eval=FALSE}
MF_single <- function(func_data, species_data = NULL, q = c(0, 1, 2))
```

The arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text. This main function computes quantification multi-fuctionality of order q  in a single ecosystem when all functions are assumed to be independent and when the correlation is considered.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>func_data</code></td>
<td align="left">The ecosystem function data can be input as a vector of functions (for a single assemblage), <code>matrix</code>/<code>data.frame</code> (assemblages by functions).\cr
The data input must be normalized between 0 and 1 already and must contain only the ecosystem function columns.</br>
For <code>species_data</code> is not <code>NULL</code>, the rownames of <code>func_data</code> should be names of 'plotID'.</td>

</tr>
<tr class="even">
<td align="center"><code>species_data</code></td>
<td align="left">The species abundance data must include three columns: 'plotID', 'species' and 'abundance'. Default is <code>NULL</code>.</td>

</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">A numerical vector specifying the diversity orders. Default is 0, 1 and 2.</td>
</tr>

</tbody>
</table>



## Multi-functionality: MF_multiple()

The other main function to measure MF is `MF_multiple()`, and the following is default arguments of the function: 

```{r eval=FALSE}
MF_multiple <- function(func_data, species_data = NULL, q = c(0, 1, 2), by_group = NULL) 
```

The arguments of this function are briefly described below, and will be explained in more details by illustrative examples in later text. This main function computes decomposition multi-fuctionality of order q  in multiple ecosystems when all functions are assumed to be independent and when the correlation is considered.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>

</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>func_data</code></td>
<td align="left">The ecosystem function data can be input as a vector of functions (for a single assemblage), <code>matrix</code>/<code>data.frame</code> (assemblages by functions).\cr
The data input must be normalized between 0 and 1 already.</br>
For <code>by_group = NULL</code> the <code>func_data</code> must contain only the ecosystem function columns. Otherwise, you must add the <code>by_group</code> column in data.
For <code>species_data</code> is not <code>NULL</code>, the rownames of <code>func_data</code> should be names of 'plotID'.</td>

</tr>
<tr class="even">
<td align="center"><code>species_data</code></td>
<td align="left">The species abundance data must include three columns: 'plotID', 'species' and 'abundance'. Default is <code>NULL</code>.</td>

</tr>
<tr class="odd">
<td align="center"><code>q</code></td>
<td align="left">A numerical vector specifying the diversity orders. Default is 0, 1 and 2.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left">Name of the column to be paired by group. Default is <code>NULL</code>.</td>
</tr>
</tbody>
</table>



The above two functions (`MF_single()` and `MF_multiple()`) returns a data.frame which can be further used to make plots using the function `ggMF()` to be described below. 



### Example Data

A forest tree species and ecosystem function data is included in `MF` package for illustration. see Baeten et al. (2013), van der Plas et al. (2016) and Ratcliffe et al. (2017) for a detailed description. In the data, a total of 209 plots (each with 30 m x 30 m) were established in mature forests in six countries, representing six major European forest types. In each country, three to five common tree species were selected for the species pool; each of the 209 plots consisted of one to five tree species. The basal area of each tree species within each plot was used as a proxy for species abundance. Within each country, there are 28 to 43 plots, where each plot is designated as an ecosystem. In each plot, a total of 26 ecosystem functions or properties were measured; see Appendix S3 of Chao et al. (2023) for a list of the 26 functions (with brief description) and their pairwise correlations.

For this data, the following commands display how to compute multi-functionality and corresponding decomposition in multiple ecosystems .

#### Ecosystem functions data

Run the following code to view raw forest data: (Here we only show the first ten rows of the first two ecosystem functions)

```{r eval=FALSE, fig.width=10}
data("Europe_Forest_raw")
Europe_Forest_raw
```

```{r echo=FALSE, fig.width=10}
data("Europe_Forest_raw")
head(cbind(Europe_Forest_raw[1:3], round(Europe_Forest_raw[4:5], 3)), 10)
```

Since the data is not normalized, we then use `func_normalized()` to do normalization. Note that, in this data, the ecosystem functions are column 4 to column 29. And there are two ecosystem functions should be normalized negatively: `"soil_cn_ff_10"` and `"wue"`. Furthermore, the performance of the ecosystem functions are quite different between six countries, thus, we do normalization and analysis among each countries.

```{r eval=FALSE}
data("Europe_Forest_raw")
func_normalized(data = Europe_Forest_raw, fun_cols = 4:29,
                negative = c("soil_cn_ff_10","wue"), by_group = "Country")
```

```{r, echo=FALSE}
norm_Europe_Forest = func_normalized(data = Europe_Forest_raw, 
                                     fun_cols = 4:29, 
                                     negative = c("soil_cn_ff_10","wue"), 
                                     by_group = "Country")
head(cbind(norm_Europe_Forest[1:3], round(norm_Europe_Forest[4:5], 3)), 10)
```


This normalized data is same as the data `Europe_Forest` in `MF.beta4` package .


#### Species abundance data

Run the following code to view complete species abundance data:

```{r eval=FALSE}
data("Europe_Forest_species")
Europe_Forest_species
```

Here, we only show the first ten rows.

```{r echo=FALSE}
data("Europe_Forest_species")
head(Europe_Forest_species,10)
```

### Computing Multi-functionality Via Example

#### If the `species_data` is not provided
For example, given a normalized data, we run the `MF_single()` function without setting `species_data` to compute uncorrelated and correlated multi-functionality. (Here we only show the first six outputs)


```{r echo=TRUE}
data("Europe_Forest")
output1 <- MF_single(func_data = Europe_Forest[,4:29])
```

```{r, echo=FALSE}
output1 %>% mutate(qMF = round(qMF,3)) %>% head(6)
```


The output contains ID of plot (`plotID`) which is according to the row names of the input data, `Type` (uncorrelated or correlated), the diversity order (`Order.q`) and multi-functionality (`qMF`).


#### If there is `species_data` given to function `MF_single`


```{r echo=TRUE}
data("Europe_Forest")
data("Europe_Forest_species")
output2 <- MF_single(func_data = Europe_Forest[,4:29],species_data = Europe_Forest_species)
```

```{r echo=FALSE}
output2 %>% mutate(qMF = round(qMF,3),
                          Species.diversity = round(Species.diversity,3)) %>% 
  head(6)
```


The output has only more one column `Species.diversity` than the previous one.


### Computing Decomposition of Multi-functionality In Multiple Ecosystems Via Example
For example, we run the `MF_multiple()` function with forest data to compute uncorrelated and correlated multi-functionality relationships across spatial scales. (Here we only show the first six outputs)

```{r eval=FALSE}
data("Europe_Forest")
output3 = MF_multiple(func_data = Europe_Forest[,4:30],
                      species_data = Europe_Forest_species,
                      by_group = "Country")
```

```{r include=FALSE}
output3 <- EF_multiple %>% 
  mutate(Type=factor(Type,levels = unique(Type)),
         Scale=factor(Scale,levels = unique(Scale))) %>%
  group_by(plotID,Country,Type,Scale) %>%
  summarise(Order.q=Order.q,
            qMF=round(qMF,3),
            Species.diversity=round(Species.diversity,3))
```


```{r echo=FALSE}
head(output3, 6)
output3 <- EF_multiple
```


Each row of the output represents the decomposition of species diversity and multi-functionality across two plots. The output contains ID (`plotID`) which is according to the row names of the input data, `Country` of two plots, `Type` (uncorrelated or correlated), `Scale` (gamma, alpha or beta), the diversity order (`Order.q`), multi-functionality (`qMF`) and decomposition of species diversity(`Species.diversity`).

For `species_data` is not provided, the column of decomposition of species diversity are not included in the output.

## Graphic Display: ggMF()

The function `ggMF()`, which extends `ggplot2` to the `"MF"` output object with default arguments, is described as follows: 

```{r eval=FALSE}
ggMF <- function(output, by_group = NULL, facets_scale = "fixed", 
                 fit = "LMM.intercept", text = "Slope")
```

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>output</code></td>
<td align="left">The output from <code>MF_single</code> or <code>MF_multiple</code>.</br>
For <code>fit</code> is selected to be linear mixed model, you must offer the <code>by_group</code>
argument.</td>

</tr>
<tr class="even">
<td align="center"><code>by_group</code></td>
<td align="left">Whether the MF object to classify by group or not. If does, input name of the
column used for grouping. Default is <code>NULL</code>.
</td>

</tr>
<tr class="odd">
<td align="center"><code>facets_scale</code></td>
<td align="left">Are scales shared across all facets (the default, <code>"fixed"</code>), or do they vary across rows (<code>"free_x"</code>), columns (<code>"free_y"</code>), or both rows and columns (<code>"free"</code>)?</td>

</tr>
<tr class="even">
<td align="center"><code>fit</code></td>
<td align="left">Method of the fitted line. Select <code>fit = "lm"</code> for the linear model, or <code>fit = "LMM.intercept"</code>, <code>fit = "LMM.slope"</code> and <code>fit = "LMM.both"</code> for the linear mixed model with random effect 'intercept', 'slope' and 'both intercept and slope', respectively.Default is <code>fit = "LMM.intercept"</code>.</td>


</tr>
<tr class="odd">
<td align="center"><code>text</code></td>
<td align="left">type of text information show in the plots. Select <code>text = "Slope"</code> to see estimated of slopes, or <code>text = "R.squared"</code> to see model performance. Default is
<code>text = "Slope"</code>.</td>

</tr>

</tbody>
</table>


The `ggMF()` function is a wrapper around the `ggplot2` package to display the relationship between species diversity and multi-functionality when <code>output</code> is from <code>MF_single</code>, or to display the relationship between the decomposition of species diversity and multi-functionality (MF alpha vs. species alpha, MF beta vs. species beta, and MF gamma vs. species gamma) when <code>output</code> is from <code>MF_multiple</code> using a single line of code. The resulting object is of class `"ggplot"` or `"list"` containing two lists of `ggplot` objects, so it can be manipulated using the `ggplot2` tools. Users can visualize the output with different methods of the fitted line by setting the parameter <code>**fit**</code>:


We first display multi-functionality in single ecosystem with `by_group` and without `by_group`.
```{r, fig.align='center', fig.height=6.5, fig.width=6.5}
ggMF(output2, facets_scale = 'fixed', fit = "lm")
```


```{r, fig.align='center', fig.height=6.5, fig.width=6.5}
output2 <- data.frame("plotID"=rownames(Europe_Forest),
                      "Country"=Europe_Forest$Country) %>% 
  left_join(output2,.,by="plotID")
ggMF(output2, by_group = "Country", facets_scale = 'fixed', 
     fit = "LMM.intercept")  
```



And then, display decomposition of multi-functionality in multiple ecosystems with linear model fitted line and linear mixed model with random effect 'intercept' fitted line.

```{r}
figure_lm <- ggMF(output3, by_group = "Country", facets_scale = 'fixed', fit = "lm")
figure_LMM <- ggMF(output3, by_group = "Country", facets_scale = 'fixed', fit = "LMM.intercept",text = "R.squared")
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_lm$Uncorrelated$ALL
figure_LMM$Uncorrelated$ALL
```

```{r, fig.align='center', fig.height=12, fig.width=6.2}
figure_LMM$Correlated$ALL
```

```{r, fig.align='center', fig.height=5, fig.width=6.2}
figure_LMM$Correlated$Gamma
figure_LMM$Correlated$Alpha
figure_LMM$Correlated$Beta
```
